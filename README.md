# Telegram Analytics Platform

Сервис для автоматизации парсинга Telegram-каналов и генерации аналитических отчетов с использованием LLM. Сервис извлекает данные из публичных каналов, обрабатывает их через искусственный интеллект и формирует готовые отчеты в формате DOCX.

Архитектура построена на базе FastAPI с интеграцией Telegram-бота через Webhook. Развертывание осуществляется в инфраструктуре Amvera Cloud.

## Функциональные возможности

1.  **Парсинг Telegram-каналов:**
    *   Автоматический сбор сообщений из публичных каналов через Telethon.
    *   Поддержка нескольких подборок каналов (source_1 - source_6).
    *   Гибкий выбор периода парсинга: сегодня, вчера, или указанное количество дней (до 365).
2.  **Генерация отчетов (LLM):**
    *   **Free Mode:** Использование Google Gemini API (модели Flash 2.5/3.0).
    *   **Paid Mode:** Использование Polza.ai (OpenAI-compatible API).
3.  **Типы отчетов:**
    *   Дайджест новостей
    *   Календарь мероприятий
    *   Дополнительные сценарии (custom_task_1, custom_task_2)
4.  **Telegram-бот:**
    *   FSM (Finite State Machine) для управления диалогом.
    *   Асинхронная обработка запросов.
    *   Уведомления о статусе генерации.
5.  **Управление памятью:**
    *   Автоматическая очистка RAM с использованием `malloc_trim` (Linux).
    *   Автоматическое удаление устаревших файлов парсинга.
    *   Периодическая сборка мусора для предотвращения утечек.

## Стек технологий

*   **Язык:** Python 3.11
*   **Web Framework:** FastAPI, Uvicorn
*   **Telegram Bot:** Aiogram 3.x (Webhook mode)
*   **Telegram Parser:** Telethon
*   **LLM Integration:** `google-genai`, `openai` SDK
*   **DOCX Generation:** `docxtpl`
*   **Utilities:** `aiohttp`, `psutil`, `aiofiles`

## Структура проекта

```
.
├── app.py                      # Точка входа FastAPI, инициализация приложения и вебхуков
├── telegram_bot.py             # Логика Telegram-бота (FSM, хендлеры)
├── setup_session.py            # CLI-скрипт для создания Telethon-сессии
├── routers/
│   ├── parser.py               # API эндпоинты для парсинга каналов
│   └── reports.py              # API эндпоинты для генерации отчетов
├── services/
│   ├── telegram_parser.py      # Сервис парсинга Telegram через Telethon
│   ├── report_generator.py     # Оркестратор: LLM -> Генерация DOCX
│   ├── llm_providers.py        # Паттерн Стратегия для LLM (Gemini/Polza)
│   ├── memory_manager.py       # Модуль управления RAM (GC, malloc_trim)
│   └── file_cleaner.py         # Автоочистка устаревших файлов
├── prompts/
│   ├── news.md                 # Промпт для дайджеста новостей
│   ├── events.md               # Промпт для календаря мероприятий
│   ├── custom_task_1.md        # Промпт для дополнительного сценария 1
│   └── custom_task_2.md        # Промпт для дополнительного сценария 2
├── templates/                  # Шаблоны DOCX для отчетов
├── data/                       # Папка для постоянного хранения (Persistent Storage)
│   ├── source_1.json           # Подборка каналов 1
│   ├── source_2.json           # Подборка каналов 2
│   └── ...                     # Подборки каналов 3-6
├── requirements.txt            # Зависимости
└── amvera.yaml                 # Конфигурация сборки Amvera
```

## Конфигурация и переменные окружения

Для работы сервиса необходимо задать следующие переменные окружения (Environment Variables). В среде Amvera они задаются в разделе "Переменные".

### Основные
| Переменная | Описание | Обязательно |
| :--- | :--- | :--- |
| `TELEGRAM_BOT_TOKEN` | Токен бота от @BotFather. | Да |
| `TELEGRAM_API_ID` | API ID для Telethon (my.telegram.org). | Да |
| `TELEGRAM_API_HASH` | API Hash для Telethon (my.telegram.org). | Да |
| `GOOGLE_API_KEY` | API ключ Google Gemini (для Free mode). | Да |
| `POLZA_API_KEY` | API ключ Polza.ai (для Paid mode). | Нет (если используется только Free) |

### Настройки приложения
| Переменная | Описание | Значение по умолчанию |
| :--- | :--- | :--- |
| `WEBHOOK_HOST` | Публичный URL приложения (например, `https://xxx.amvera.io`). Необходим для Telegram Webhook. | - |
| `ALLOWED_USERS` | Список ID пользователей Telegram через запятую, имеющих доступ к боту. | (доступ всем) |
| `ADMIN_TOKEN` | Токен для доступа к /admin/ эндпоинтам (заголовок X-Admin-Token). | (эндпоинты открыты) |
| `API_BASE_URL` | Базовый URL API для внутренней коммуникации бота. | `http://localhost:80` |
| `API_TIMEOUT` | Таймаут ожидания ответа от LLM (сек). | `900` |
| `ENABLE_MEMORY_CLEANUP` | Включение активного менеджера памяти. | `true` |
| `ENABLE_FILE_CLEANUP` | Включение автоочистки устаревших файлов. | `true` |
| `RETENTION_DAYS` | Количество дней хранения файлов парсинга. | `7` |

### Специфичные для Amvera
Приложение автоматически определяет среду Amvera по наличию переменной окружения `AMVERA` (устанавливается платформой).
*   Если `AMVERA=1`: пути к файлам конфигурации ищутся в `/data/`.
*   Локально: пути ищутся в `data/` относительно корня проекта.

## Развертывание на Amvera Cloud

Проект подготовлен для деплоя через Amvera. Конфигурация сборки описана в `amvera.yaml`.

1.  **Создание проекта:**
    Создайте проект в Amvera, выберите тип "Приложения".
2.  **Загрузка кода:**
    Подключите репозиторий Git или загрузите файлы напрямую в "Репозиторий".
3.  **Настройка переменных:**
    В интерфейсе Amvera перейдите в раздел "Переменные" и добавьте все обязательные ключи, указанные выше. Для API ключей и токенов выбирайте "Это секрет".
4.  **Persistent Storage (Важно):**
    Приложение ожидает наличие файлов в папке `/data/`. В Amvera папка `/data` является монтируемым разделом для постоянного хранения.
    *   Перейдите в раздел "Репозиторий" вашего проекта в Amvera, вкладка "Data".
    *   Загрузите файл `telegram_parser_session.session` (Telethon-сессия).
    *   Загрузите файлы подборок каналов (`source_1.json` - `source_6.json`).
    *   **Без сессии Telethon сервис не сможет парсить каналы.**
5.  **Сборка и запуск:**
    Запустите сборку. Amvera автоматически установит зависимости из `requirements.txt` и запустит команду:
    `uvicorn app:app --host 0.0.0.0 --port 80`

## API Эндпоинты

Swagger UI доступен по адресу `/docs` после запуска.

### Парсинг

#### `POST /api/parser/parse`
Парсит Telegram-каналы и возвращает данные.

#### `POST /api/parser/parse-and-save`
Парсит каналы и сохраняет результат в файл.

### Генерация отчетов

#### `POST /api/reports/generate`
Генерация отчета из уже спарсенных данных.

#### `POST /api/reports/generate-from-file`
Генерация отчета из сохраненного файла парсинга.

#### `POST /api/reports/parse-and-generate`
Полный цикл: парсинг + генерация отчета. Основной эндпоинт для бота.

#### `GET /api/reports/types`
Список доступных типов отчетов.

### Telegram Webhook

#### `POST /telegram-webhook`
Точка входа для обновлений от Telegram. Обрабатывает сообщения и callback-запросы бота.

### Администрирование

> ⚠️ При установленной переменной `ADMIN_TOKEN` требуется заголовок `X-Admin-Token`.

#### `GET /admin/memory-stats`
Возвращает текущую статистику потребления RAM.

#### `POST /admin/memory-cleanup`
Ручной запуск очистки RAM.

#### `POST /admin/force-gc`
Принудительный запуск полной сборки мусора.

#### `GET /admin/memory-detailed`
Детальная диагностика памяти: RSS, Page Cache, Buffers.

#### `GET /admin/disk-usage`
Показывает размер файлов на диске в /data/.

## Локальная разработка

1.  Создайте виртуальное окружение:
    ```bash
    python -m venv venv
    source venv/bin/activate  # Linux/Mac
    venv\Scripts\activate     # Windows
    ```
2.  Установите зависимости:
    ```bash
    pip install -r requirements.txt
    ```
3.  Создайте файл `.env` в корне проекта и заполните его переменными (см. раздел Конфигурация).
4.  **Создайте Telethon-сессию:**
    ```bash
    python setup_session.py
    ```
    Следуйте инструкциям для авторизации в Telegram.
5.  Убедитесь, что папка `data/` содержит файлы подборок каналов (`source_*.json`).
6.  Для запуска API сервера:
    ```bash
    uvicorn app:app --reload
    ```

> **Примечание:** Для локального тестирования бота без Webhook можно использовать polling-режим или настроить туннель (ngrok).
